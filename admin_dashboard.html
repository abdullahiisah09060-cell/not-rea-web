<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA | MASTER ADMIN</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0b0e11; color: white; font-family: sans-serif; padding: 0; margin: 0; display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #161a1e; padding: 15px; border-bottom: 2px solid #3498db; }
        .tab-bar { display: flex; background: #161a1e; border-bottom: 1px solid #2c2f36; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 11px; font-weight: bold; text-transform: uppercase; color: #888; cursor: pointer; position: relative; }
        .tab.active { color: #3498db; border-bottom: 3px solid #3498db; background: rgba(52, 152, 219, 0.1); }
        .badge { position: absolute; top: 10px; right: 15%; width: 8px; height: 8px; background: #ff4757; border-radius: 50%; display: none; }
        .content-area { padding: 15px; padding-bottom: 80px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stat-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; border: 1px solid #3498db; text-align: center; flex: 1; }
        .card { background: #161a1e; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #2c2f36; }
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; transition: 0.3s; }
        .btn-approve { background: #2ecc71; color: white; width: 48%; }
        .btn-decline { background: #e74c3c; color: white; width: 48%; }
        .btn-del { background: transparent; color: #ff4757; margin-top: 10px; width: 100%; border: 1px solid #ff4757; }
        .chat-input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #3498db; background: #0b0e11; color: white; outline: none; }
        
        /* Chat Overlay UI */
        #chat-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0e11; z-index: 1000; flex-direction: column; }
        .chat-header { padding: 15px; background: #161a1e; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #3498db; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .m-bubble { padding: 10px 14px; border-radius: 12px; max-width: 80%; font-size: 14px; }
        .m-user { background: #2c2f36; align-self: flex-start; }
        .m-admin { background: #3498db; align-self: flex-end; }
        .chat-footer { padding: 15px; display: flex; gap: 10px; background: #161a1e; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="font-size: 16px; margin: 0;">SBA MASTER</h1>
    <button onclick="logout()" class="btn" style="background:#e74c3c; color:white;">Logout</button>
</div>

<div class="tab-bar">
    <div class="tab active" onclick="openTab(event, 'pending-tab')">Requests <span id="dot-req" class="badge"></span></div>
    <div class="tab" onclick="openTab(event, 'users-tab')">Users</div>
    <div class="tab" onclick="openTab(event, 'chat-tab')">Messages <span id="dot-msg" class="badge"></span></div>
</div>

<div class="content-area">
    <div id="pending-tab" class="tab-content active"><div id="request-list"></div></div>
    <div id="users-tab" class="tab-content">
        <div class="stat-container">
            <div class="stat-box"><small>Users</small><br><b id="stat-users">0</b></div>
            <div class="stat-box"><small>Vault</small><br><b id="stat-balance">$0</b></div>
        </div>
        <div id="user-list"></div>
    </div>
    <div id="chat-tab" class="tab-content"><div id="admin-chat-area"></div></div>
</div>

<div id="chat-overlay">
    <div class="chat-header">
        <button class="btn" style="background:#444; color:white;" onclick="closeChat()">‚Üê Back</button>
        <span id="chat-title">User Chat</span>
    </div>
    <div id="chat-msgs"></div>
    <div class="chat-footer">
        <input type="text" id="admin-reply-input" class="chat-input" placeholder="Type a reply...">
        <button class="btn" style="background:#3498db; color:white; width:80px;" onclick="sendReply()">Send</button>
    </div>
</div>

<script>
    let activeChatEmail = "";

    function openTab(evt, tabName) {
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    auth.onAuthStateChanged(u => { 
        if(u && u.email === "abdullahiisah09060@gmail.com") { document.body.style.display="block"; loadData(); }
        else { window.location.href="index.html"; }
    });

    function loadData() {
        // 1. Load Requests
        db.collection('requests').where('status', '==', 'pending').onSnapshot(snap => {
            document.getElementById('dot-req').style.display = snap.empty ? "none" : "block";
            let h = '';
            snap.forEach(doc => {
                const r = doc.data();
                h += `<div class="card">
                    <b>${r.email}</b><br><small>${r.type.toUpperCase()}</small><br>
                    <span style="color:#2ecc71; font-weight:bold">$${Number(r.amount).toLocaleString()}</span>
                    <div style="margin-top:10px; display:flex; justify-content:space-between">
                        <button class="btn btn-approve" onclick="approve('${doc.id}', '${r.email}', ${r.amount}, '${r.type}')">APPROVE</button>
                        <button class="btn btn-decline" onclick="decline('${doc.id}')">DECLINE</button>
                    </div>
                </div>`;
            });
            document.getElementById('request-list').innerHTML = h || '<p align="center">No pending requests.</p>';
        });

        // 2. Load Users with Balance Edit
        db.collection('users').onSnapshot(snap => {
            let h = ''; let total = 0;
            snap.forEach(doc => {
                const u = doc.data(); 
                const emailId = doc.id;
                total += Number(u.balance || 0);
                h += `<div class="card">
                    <b>${u.fullName || 'User'}</b><br><small>${emailId}</small><br>
                    <span style="color:#2ecc71; font-size: 18px;">$${Number(u.balance || 0).toLocaleString()}</span>
                    <div style="display:flex; gap:5px; margin-top:10px">
                        <input type="number" id="amt-${emailId.replace(/[^a-z0-9]/g,'')}" class="chat-input" placeholder="Amount">
                        <button class="btn" style="background:#3498db; color:white" onclick="editBal('${emailId}', 'add')">ADD</button>
                        <button class="btn" style="background:#888; color:white" onclick="editBal('${emailId}', 'sub')">SUB</button>
                    </div>
                    <button class="btn btn-del" onclick="deleteUser('${emailId}')">DELETE USER</button>
                </div>`;
            });
            document.getElementById('user-list').innerHTML = h;
            document.getElementById('stat-users').innerText = snap.size;
            document.getElementById('stat-balance').innerText = '$' + total.toLocaleString();
        });

        // 3. Load Chat List
        db.collection('chats').orderBy('timestamp', 'desc').onSnapshot(snap => {
            let userChats = {};
            snap.forEach(doc => {
                const m = doc.data();
                if (!userChats[m.userEmail]) userChats[m.userEmail] = m;
            });

            let h = '';
            for (let email in userChats) {
                h += `<div class="card" onclick="openChat('${email}')" style="cursor:pointer; border-left: 4px solid #3498db;">
                    <b style="color:#3498db">${email}</b><br>
                    <small style="opacity:0.7">${userChats[email].text || userChats[email].message}</small>
                </div>`;
            }
            document.getElementById('admin-chat-area').innerHTML = h || '<p align="center">No messages.</p>';
        });
    }

    async function approve(docId, email, amt, type) {
        if(!confirm("Approve this transaction?")) return;
        const uRef = db.collection('users').doc(email);
        const uDoc = await uRef.get();
        if(uDoc.exists) {
            let cur = Number(uDoc.data().balance || 0);
            let newBal = (type === 'withdrawal') ? cur - amt : cur + amt;
            await uRef.update({ balance: newBal });
            await db.collection('requests').doc(docId).update({ status: 'successful' });
            alert("Approved Successfully!");
        } else { alert("User profile not found for " + email); }
    }

    async function decline(id) { if(confirm("Decline?")) await db.collection('requests').doc(id).update({ status: 'declined' }); }

    async function editBal(email, type) {
        const safeId = email.replace(/[^a-z0-9]/g,'');
        let val = Number(document.getElementById('amt-' + safeId).value);
        if(!val) return;
        let ref = db.collection('users').doc(email);
        let d = await ref.get();
        let newB = type === 'add' ? (Number(d.data().balance || 0) + val) : (Number(d.data().balance || 0) - val);
        await ref.update({ balance: newB });
        document.getElementById('amt-' + safeId).value = '';
        alert("Balance Updated");
    }

    // Chat Overlay Functions
    let chatUnsub = null;
    function openChat(email) {
        activeChatEmail = email;
        document.getElementById('chat-title').innerText = email;
        document.getElementById('chat-overlay').style.display = 'flex';
        
        if(chatUnsub) chatUnsub();
        chatUnsub = db.collection('chats').where('userEmail', '==', email).orderBy('timestamp', 'asc').onSnapshot(snap => {
            let h = '';
            snap.forEach(doc => {
                const m = doc.data();
                const cls = m.sender === 'admin' ? 'm-admin' : 'm-user';
                h += `<div class="m-bubble ${cls}">${m.text || m.message}</div>`;
            });
            const box = document.getElementById('chat-msgs');
            box.innerHTML = h;
            box.scrollTop = box.scrollHeight;
        });
    }

    function closeChat() { 
        document.getElementById('chat-overlay').style.display = 'none'; 
        if(chatUnsub) chatUnsub(); 
    }

    async function sendReply() {
        const txt = document.getElementById('admin-reply-input').value;
        if(!txt || !activeChatEmail) return;
        await db.collection('chats').add({
            userEmail: activeChatEmail, text: txt, sender: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('admin-reply-input').value = '';
    }

    async function deleteUser(email) { if(confirm("Delete user?")) await db.collection('users').doc(email).delete(); }
</script>
</body>
</html>

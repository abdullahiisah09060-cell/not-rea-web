<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA | MASTER ADMIN</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0b0e11; color: white; font-family: sans-serif; padding: 0; margin: 0; display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #161a1e; padding: 15px; border-bottom: 2px solid #3498db; }
        .tab-bar { display: flex; background: #161a1e; border-bottom: 1px solid #2c2f36; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 11px; font-weight: bold; text-transform: uppercase; color: #888; cursor: pointer; position: relative; }
        .tab.active { color: #3498db; border-bottom: 3px solid #3498db; background: rgba(52, 152, 219, 0.1); }
        .badge { position: absolute; top: 10px; right: 15%; width: 8px; height: 8px; background: #ff4757; border-radius: 50%; display: none; }
        .content-area { padding: 15px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: #161a1e; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #2c2f36; }
        .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        /* Chat Inbox Style */
        .chat-user-item { padding: 15px; border-bottom: 1px solid #2c2f36; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .chat-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0e11; z-index: 200; display: none; flex-direction: column; }
        .chat-header { padding: 15px; background: #161a1e; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #3498db; }
        .msg-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 14px; }
        .msg.admin { align-self: flex-end; background: #3498db; }
        .msg.user { align-self: flex-start; background: #2c2f36; border: 1px solid #444; }
        .chat-input-area { padding: 15px; background: #161a1e; display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #0b0e11; border: 1px solid #3498db; color: white; padding: 10px; border-radius: 5px; outline: none; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="font-size: 16px; margin: 0;">SBA MASTER</h1>
    <button onclick="logout()" class="btn" style="background:#e74c3c; color:white;">Logout</button>
</div>

<div class="tab-bar">
    <div class="tab active" onclick="openTab(event, 'pending-tab')">Requests <span id="dot-req" class="badge"></span></div>
    <div class="tab" onclick="openTab(event, 'users-tab')">Users</div>
    <div class="tab" onclick="openTab(event, 'chat-tab')">Inbox <span id="dot-msg" class="badge"></span></div>
</div>

<div class="content-area">
    <div id="pending-tab" class="tab-content active"><div id="request-list"></div></div>
    <div id="users-tab" class="tab-content"><div id="user-list"></div></div>
    <div id="chat-tab" class="tab-content"><div id="inbox-list"></div></div>
</div>

<div id="chat-window" class="chat-window">
    <div class="chat-header">
        <i class="fa fa-arrow-left" onclick="closeChat()"></i>
        <span id="current-chat-user">User Email</span>
    </div>
    <div id="msg-box" class="msg-box"></div>
    <div class="chat-input-area">
        <input type="text" id="admin-reply-input" class="chat-input" placeholder="Type reply...">
        <button class="btn" style="background:#2ecc71; color:white;" onclick="sendAdminReply()">SEND</button>
    </div>
</div>

<script>
    let activeChatEmail = "";

    function openTab(evt, tabName) {
        let contents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < contents.length; i++) contents[i].classList.remove("active");
        let tabs = document.getElementsByClassName("tab");
        for (let i = 0; i < tabs.length; i++) tabs[i].classList.remove("active");
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    auth.onAuthStateChanged(u => { 
        if(u && u.email === "abdullahiisah09060@gmail.com") { 
            document.body.style.display="block"; loadData(); 
        } else { window.location.href="index.html"; }
    });

    function loadData() {
        // Requests logic
        db.collection('requests').where('status', '==', 'pending').onSnapshot(snap => {
            document.getElementById('dot-req').style.display = snap.empty ? "none" : "block";
            let h = ''; snap.forEach(doc => {
                const r = doc.data();
                h += `<div class="card"><b>${r.email}</b><br><small>${r.type}</small><h3>$${r.amount}</h3>
                <button class="btn" style="background:#2ecc71; color:white;" onclick="approve('${doc.id}', '${r.email}', ${r.amount})">APPROVE</button></div>`;
            });
            document.getElementById('request-list').innerHTML = h || "No requests";
        });

        // Users List
        db.collection('users').onSnapshot(snap => {
            let h = ''; snap.forEach(doc => {
                const u = doc.data();
                h += `<div class="card"><b>${u.fullName}</b><br><small>${u.email}</small><br><b>$${u.balance}</b>
                <button class="btn" style="background:#ff4757; color:white; width:100%; margin-top:10px;" onclick="deleteUser('${doc.id}')">DELETE USER</button></div>`;
            });
            document.getElementById('user-list').innerHTML = h;
        });

        // Chat Inbox Logic
        db.collection('chats').orderBy('timestamp', 'desc').onSnapshot(snap => {
            let users = [];
            let unreplied = false;
            snap.forEach(doc => {
                const d = doc.data();
                if(!users.includes(d.userEmail)) {
                    users.push(d.userEmail);
                    if(d.sender === 'user') unreplied = true;
                }
            });
            document.getElementById('dot-msg').style.display = unreplied ? "block" : "none";
            let h = '';
            users.forEach(email => {
                h += `<div class="chat-user-item" onclick="openChat('${email}')">
                    <span>${email}</span><i class="fa fa-chevron-right"></i>
                </div>`;
            });
            document.getElementById('inbox-list').innerHTML = h || "No chats";
        });
    }

    function openChat(email) {
        activeChatEmail = email;
        document.getElementById('current-chat-user').innerText = email;
        document.getElementById('chat-window').style.display = "flex";
        
        db.collection('chats').where('userEmail', '==', email).orderBy('timestamp', 'asc').onSnapshot(snap => {
            let h = '';
            snap.forEach(doc => {
                const m = doc.data();
                h += `<div class="msg ${m.sender}">${m.message}</div>`;
            });
            const box = document.getElementById('msg-box');
            box.innerHTML = h;
            box.scrollTop = box.scrollHeight;
        });
    }

    function closeChat() { document.getElementById('chat-window').style.display = "none"; }

    async function sendAdminReply() {
        const input = document.getElementById('admin-reply-input');
        if(!input.value.trim()) return;
        await db.collection('chats').add({
            userEmail: activeChatEmail,
            message: input.value,
            sender: 'admin',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = "";
    }

    async function deleteUser(id) { if(confirm("Delete User?")) await db.collection('users').doc(id).delete(); }

    async function approve(id, email, amt) {
        const uQuery = await db.collection('users').where('email', '==', email).get();
        if(!uQuery.empty) {
            const uRef = uQuery.docs[0].ref;
            const newBal = Number(uQuery.docs[0].data().balance || 0) + Number(amt);
            await uRef.update({ balance: newBal });
            await db.collection('requests').doc(id).update({ status: 'successful' });
            alert("Approved!");
        }
    }
</script>
</body>
</html>

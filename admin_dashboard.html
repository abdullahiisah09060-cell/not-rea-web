<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA MASTER ADMIN</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; margin: 0; display: none; }
        .tabs { display: flex; background: #161a1e; border-bottom: 2px solid #3498db; position: sticky; top: 0; z-index: 10; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-size: 12px; font-weight: bold; position: relative; color: #888; }
        .tab.active { color: #3498db; background: rgba(52, 152, 219, 0.1); }
        .dot { height: 8px; width: 8px; background: red; border-radius: 50%; position: absolute; top: 8px; right: 15%; display: none; }
        
        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        
        .card { background: #161a1e; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #2c2f36; }
        .btn { padding: 8px 12px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; margin-top: 5px; }
        input { width: 100%; padding: 10px; margin: 5px 0; background: #0b0e11; border: 1px solid #3498db; color: white; border-radius: 8px; box-sizing: border-box; }
        
        /* Chat Popup */
        #chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; z-index: 1000; }
        #chat-box-admin { width: 90%; max-width: 400px; margin: auto; background: #161a1e; height: 80vh; border-radius: 15px; display: flex; flex-direction: column; }
    </style>
</head>
<body>

<div class="tabs">
    <div class="tab active" onclick="show('p-req')">Requests <div id="dot-r" class="dot"></div></div>
    <div class="tab" onclick="show('p-usr')">Users</div>
    <div class="tab" onclick="show('p-msg')">Inbox <div id="dot-m" class="dot"></div></div>
    <div class="tab" onclick="auth.signOut()" style="background:#e74c3c; color:white;">OUT</div>
</div>

<div id="p-req" class="page active"><div id="req-list"></div></div>
<div id="p-usr" class="page">
    <input type="text" id="find" placeholder="Search user..." onkeyup="filter()">
    <div id="usr-list"></div>
</div>
<div id="p-msg" class="page"><div id="msg-list"></div></div>

<div id="chat-overlay">
    <div id="chat-box-admin">
        <div style="padding:15px; border-bottom:1px solid #3498db; display:flex; justify-content:space-between;">
            <span id="target">Email</span>
            <b onclick="closeChat()" style="cursor:pointer;">X</b>
        </div>
        <div id="m-content" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px;"></div>
        <div style="padding:15px; display:flex; gap:5px;">
            <input type="text" id="replyInp" placeholder="Type reply...">
            <button class="btn" style="background:#2ecc71;" onclick="sendReply()">SEND</button>
        </div>
    </div>
</div>

<script>
    let activeEmail = "";

    function show(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    auth.onAuthStateChanged(u => {
        if(u && u.email === "abdullahiisah09060@gmail.com") { document.body.style.display="block"; start(); }
        else { window.location.href="index.html"; }
    });

    function start() {
        // Requests
        db.collection('requests').where('status', '==', 'pending').onSnapshot(snap => {
            document.getElementById('dot-r').style.display = snap.empty ? 'none' : 'block';
            let h = ''; snap.forEach(doc => {
                const r = doc.data();
                h += `<div class="card"><b>${r.email}</b><br><small>${r.type}</small><h3>$${r.amount}</h3>
                <button class="btn" style="background:#2ecc71;" onclick="appr('${doc.id}','${r.email}',${r.amount})">APPROVE</button>
                <button class="btn" style="background:#e74c3c;" onclick="decl('${doc.id}')">DECLINE</button></div>`;
            });
            document.getElementById('req-list').innerHTML = h || "No requests";
        });

        // Users
        db.collection('users').onSnapshot(snap => {
            let h = ''; snap.forEach(doc => {
                const u = doc.data();
                h += `<div class="card u-card"><b>${u.fullName}</b><br><small>${u.email}</small><br><b>Bal: $${u.balance}</b>
                <input type="number" id="v-${doc.id}" placeholder="Amount">
                <button class="btn" style="background:#3498db;" onclick="upd('${doc.id}','add')">ADD</button>
                <button class="btn" style="background:#888;" onclick="upd('${doc.id}','sub')">SUB</button>
                <button class="btn" style="background:#ff4757; width:100%;" onclick="del('${doc.id}')">DELETE USER</button></div>`;
            });
            document.getElementById('usr-list').innerHTML = h;
        });

        // Inbox
        db.collection('chats').orderBy('timestamp', 'desc').onSnapshot(snap => {
            let list = []; let un = false;
            snap.forEach(doc => {
                if(!list.includes(doc.data().userEmail)) {
                    list.push(doc.data().userEmail);
                    if(doc.data().sender === 'user') un = true;
                }
            });
            document.getElementById('dot-m').style.display = un ? 'block' : 'none';
            let h = ''; list.forEach(e => {
                h += `<div class="card" onclick="openChat('${e}')">${e} <span style="float:right;">â†’</span></div>`;
            });
            document.getElementById('msg-list').innerHTML = h || "Empty Inbox";
        });
    }

    async function appr(id, email, amt) {
        const uS = await db.collection('users').where('email', '==', email).get();
        if(!uS.empty) {
            const uR = uS.docs[0].ref;
            const b = Number(uS.docs[0].data().balance || 0);
            await uR.update({ balance: b + Number(amt) });
            await db.collection('requests').doc(id).update({ status: 'successful' });
        }
    }

    async function decl(id) { await db.collection('requests').doc(id).update({ status: 'declined' }); }

    async function upd(id, type) {
        const val = Number(document.getElementById('v-'+id).value);
        if(!val) return;
        const ref = db.collection('users').doc(id);
        const doc = await ref.get();
        const b = Number(doc.data().balance || 0);
        await ref.update({ balance: type === 'add' ? b + val : b - val });
        document.getElementById('v-'+id).value = '';
    }

    async function del(id) { if(confirm("Delete user?")) await db.collection('users').doc(id).delete(); }

    function openChat(e) {
        activeEmail = e;
        document.getElementById('target').innerText = e;
        document.getElementById('chat-overlay').style.display = 'flex';
        db.collection('chats').where('userEmail', '==', e).orderBy('timestamp', 'asc').onSnapshot(snap => {
            let h = ''; snap.forEach(doc => {
                const m = doc.data();
                const s = m.sender === 'admin' ? 'background:#3498db; align-self:flex-end;' : 'background:#2c2f36;';
                h += `<div style="padding:8px; border-radius:8px; max-width:80%; ${s}">${m.message}</div>`;
            });
            const c = document.getElementById('m-content');
            c.innerHTML = h; c.scrollTop = c.scrollHeight;
        });
    }

    function closeChat() { document.getElementById('chat-overlay').style.display = 'none'; }

    async function sendReply() {
        const i = document.getElementById('replyInp');
        if(!i.value) return;
        await db.collection('chats').add({
            userEmail: activeEmail, message: i.value, sender: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        i.value = "";
    }

    function filter() {
        let q = document.getElementById('find').value.toLowerCase();
        document.querySelectorAll('.u-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(q) ? '' : 'none');
    }
</script>
</body>
</html>

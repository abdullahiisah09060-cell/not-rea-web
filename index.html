<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA | MASTER ADMIN</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; margin: 0; display: none; }
        .tab-bar { display: flex; background: #161a1e; border-bottom: 2px solid #3498db; position: sticky; top: 0; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-size: 12px; font-weight: bold; }
        .active { color: #3498db; border-bottom: 3px solid #3498db; }
        .card { background: #161a1e; padding: 15px; margin: 10px; border-radius: 10px; border: 1px solid #2c2f36; }
        .btn { border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .btn-app { background: #2ecc71; color: white; width: 48%; }
        .btn-dec { background: #e74c3c; color: white; width: 48%; }
        .btn-del { background: #444; color: #ff4757; width: 100%; border: 1px solid #ff4757; }
        .chat-input { width: 70%; padding: 8px; border-radius: 5px; background: #0b0e11; color: white; border: 1px solid #3498db; }
    </style>
</head>
<body>

<div class="tab-bar">
    <div class="tab active" onclick="openTab('req')">Requests</div>
    <div class="tab" onclick="openTab('users')">Users</div>
    <div class="tab" onclick="openTab('msgs')">Messages</div>
    <div class="tab" style="color:red" onclick="logout()">Logout</div>
</div>

<div id="req" class="content">
    <h3 style="padding-left:10px">Pending Approvals</h3>
    <div id="request-list"></div>
</div>

<div id="users" class="content" style="display:none">
    <h3 style="padding-left:10px">All Users</h3>
    <div id="user-list"></div>
</div>

<div id="msgs" class="content" style="display:none">
    <h3 style="padding-left:10px">Support Inbox</h3>
    <div id="chat-list"></div>
</div>

<script>
    function openTab(id) {
        document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        event.currentTarget.classList.add('active');
    }

    auth.onAuthStateChanged(u => {
        if(u && u.email === "abdullahiisah09060@gmail.com") {
            document.body.style.display = "block";
            loadAdminData();
        } else { window.location.href = "index.html"; }
    });

    function loadAdminData() {
        // 1. Load Requests
        db.collection('requests').where('status', '==', 'pending').onSnapshot(snap => {
            let h = '';
            snap.forEach(doc => {
                const r = doc.data();
                h += `<div class="card">
                    <b>${r.email}</b><br>Type: ${r.type} | Amount: $${r.amount}
                    <div style="display:flex; justify-content:space-between; margin-top:10px">
                        <button class="btn btn-app" onclick="approveReq('${doc.id}', '${r.email}', ${r.amount}, '${r.type}')">APPROVE</button>
                        <button class="btn btn-dec" onclick="declineReq('${doc.id}')">DECLINE</button>
                    </div>
                </div>`;
            });
            document.getElementById('request-list').innerHTML = h || '<p align="center">No requests.</p>';
        });

        // 2. Load Users (With Delete & Balance Edit)
        db.collection('users').onSnapshot(snap => {
            let h = '';
            snap.forEach(doc => {
                const u = doc.data();
                h += `<div class="card">
                    <b>${u.fullName}</b> (${u.email})<br>Balance: <span style="color:#2ecc71">$${u.balance}</span>
                    <div style="margin: 10px 0">
                        <input type="number" id="amt-${doc.id}" style="width:60px" placeholder="$">
                        <button class="btn" style="background:#3498db; color:white" onclick="adjBal('${doc.id}', 'add')">ADD</button>
                        <button class="btn" style="background:#888; color:white" onclick="adjBal('${doc.id}', 'sub')">SUB</button>
                    </div>
                    <button class="btn btn-del" onclick="delUser('${doc.id}')">DELETE USER</button>
                </div>`;
            });
            document.getElementById('user-list').innerHTML = h;
        });

        // 3. Load Chats
        db.collection('chats').orderBy('timestamp', 'desc').onSnapshot(snap => {
            let groups = {};
            snap.forEach(doc => { 
                let m = doc.data(); 
                if(!groups[m.userEmail]) groups[m.userEmail] = { msg: m.message, sender: m.sender };
            });
            let h = '';
            for(let email in groups) {
                h += `<div class="card">
                    <small style="color:#3498db">${email}</small>
                    <p>${groups[email].msg}</p>
                    <input type="text" id="rep-${email.replace(/[^a-z]/g,'')}" class="chat-input" placeholder="Reply...">
                    <button class="btn" style="background:#2ecc71; color:white" onclick="reply('${email}')">SEND</button>
                </div>`;
            }
            document.getElementById('chat-list').innerHTML = h;
        });
    }

    // --- ACTIONS ---
    async function approveReq(id, email, amt, type) {
        if(!confirm("Approve this?")) return;
        const uDoc = await db.collection('users').doc(email).get();
        if(uDoc.exists) {
            let cur = Number(uDoc.data().balance || 0);
            let newBal = (type === 'withdrawal') ? cur - amt : cur + amt;
            await db.collection('users').doc(email).update({ balance: newBal });
            await db.collection('requests').doc(id).update({ status: 'successful' });
        }
    }

    async function declineReq(id) {
        await db.collection('requests').doc(id).update({ status: 'declined' });
    }

    async function adjBal(docId, type) {
        let v = Number(document.getElementById('amt-'+docId).value);
        let ref = db.collection('users').doc(docId);
        let d = await ref.get();
        let b = Number(d.data().balance || 0);
        await ref.update({ balance: type === 'add' ? b + v : b - v });
    }

    async function delUser(id) {
        if(confirm("Delete permanently?")) await db.collection('users').doc(id).delete();
    }

    async function reply(email) {
        let cid = email.replace(/[^a-z]/g,'');
        let txt = document.getElementById('rep-'+cid).value;
        if(!txt) return;
        await db.collection('chats').add({
            userEmail: email, message: txt, sender: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('rep-'+cid).value = '';
    }
</script>
</body>
</html>

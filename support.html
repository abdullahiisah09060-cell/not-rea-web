<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>SBA Support</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* This part ensures the app takes exactly the screen height and nothing more */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background: #002366; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .main-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            height: -webkit-fill-available; /* Fix for mobile Safari */
        }

        /* Fixed Header */
        .header { 
            background: #002366; 
            padding: 15px 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            color: white; 
            flex-shrink: 0; /* Prevents header from shrinking */
        }
        .back-btn { font-size: 20px; color: white; text-decoration: none; padding: 5px; }

        /* Chat Area - This grows to fill space */
        .chat-area { 
            flex: 1; 
            background: #f4f7f9; 
            border-top-left-radius: 25px; 
            border-top-right-radius: 25px; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            -webkit-overflow-scrolling: touch; /* Smooth scroll for iOS */
        }

        /* Message Bubbles */
        .msg { padding: 12px 16px; border-radius: 18px; font-size: 14px; max-width: 80%; line-height: 1.4; word-wrap: break-word; }
        .rec { background: white; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .sen { background: #002366; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }

        /* Footer - Forced to stay at bottom */
        .footer { 
            background: white; 
            padding: 10px 15px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-shrink: 0; 
            padding-bottom: env(safe-area-inset-bottom, 15px); /* Fix for iPhone Notch */
        }
        .input-box { 
            flex: 1; 
            background: #f0f2f5; 
            border: none; 
            padding: 12px 18px; 
            border-radius: 25px; 
            outline: none; 
            font-size: 16px; /* 16px prevents auto-zoom on iPhone */
        }
        .send-btn { 
            background: #002366; 
            color: white; 
            border: none; 
            width: 42px; 
            height: 42px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <a href="dashboard.html" class="back-btn"><i class="fa fa-chevron-left"></i></a>
        <div class="header-info">
            <h2 style="margin:0; font-size:17px;">Support Agent</h2>
            <small style="color:#2ecc71">‚óè Online</small>
        </div>
    </div>

    <div class="chat-area" id="box">
        </div>

    <div class="footer">
        <input type="text" id="in" class="input-box" placeholder="Message...">
        <button class="send-btn" onclick="send()"><i class="fa fa-paper-plane"></i></button>
    </div>
</div>

<script>
    const box = document.getElementById('box');
    const welcome = "Hello! üëã How can we help you today?";

    auth.onAuthStateChanged(user => {
        if(user) {
            db.collection('chats').where('userEmail', '==', user.email.toLowerCase()).onSnapshot(snap => {
                let msgs = [];
                snap.forEach(doc => msgs.push(doc.data()));
                msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                let html = `<div class="msg rec">${welcome}</div>`;
                msgs.forEach(m => {
                    html += `<div class="msg ${m.sender==='user'?'sen':'rec'}">${m.text || m.message}</div>`;
                });
                box.innerHTML = html;
                box.scrollTop = box.scrollHeight;
            });
        } else { window.location.href="index.html"; }
    });

    async function send() {
        const input = document.getElementById('in');
        const val = input.value.trim();
        if(!val) return;
        input.value = '';
        await db.collection('chats').add({
            userEmail: auth.currentUser.email.toLowerCase(),
            text: val,
            sender: 'user',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        box.scrollTop = box.scrollHeight;
    }

    // Handle Enter key
    document.getElementById('in').addEventListener("keypress", (e) => { if(e.key === "Enter") send(); });
</script>

</body>
</html>

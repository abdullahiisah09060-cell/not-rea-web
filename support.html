<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA MASTER ADMIN</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; margin: 0; display: none; }
        .nav { display: flex; background: #161a1e; border-bottom: 2px solid #3498db; position: sticky; top: 0; z-index: 100; }
        .nav-item { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }
        .nav-item.active { color: #3498db; background: rgba(52, 152, 219, 0.1); border-bottom: 2px solid #3498db; }
        
        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        
        .card { background: #161a1e; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #2c2f36; position: relative; }
        .status-badge { float: right; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .btn { padding: 10px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 12px; }
        input { width: 100%; padding: 12px; margin: 8px 0; background: #0b0e11; border: 1px solid #3498db; color: white; border-radius: 8px; box-sizing: border-box; }
        
        /* Chat Overlay */
        #admin-chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 1000; flex-direction: column; }
        #chat-window { width: 95%; max-width: 400px; height: 85vh; background: #161a1e; margin: auto; border-radius: 15px; display: flex; flex-direction: column; }
    </style>
</head>
<body>

<div class="nav">
    <div class="nav-item active" onclick="tab('requests')">Pending</div>
    <div class="nav-item" onclick="tab('history')">History</div>
    <div class="nav-item" onclick="tab('users')">Users</div>
    <div class="nav-item" onclick="tab('inbox')">Inbox</div>
    <div class="nav-item" onclick="logout()" style="color:#e74c3c">Exit</div>
</div>

<div id="requests" class="page active"><div id="list-req">Loading...</div></div>

<div id="history" class="page">
    <h3 style="color:#3498db">Transaction History</h3>
    <div id="list-history">No history.</div>
</div>

<div id="users" class="page">
    <input type="text" id="userSearch" placeholder="Search by name or email..." onkeyup="filter()">
    <div id="list-users">Loading Users...</div>
</div>

<div id="inbox" class="page"><div id="list-chats">No messages.</div></div>

<div id="admin-chat-overlay">
    <div id="chat-window">
        <div style="padding:15px; border-bottom:1px solid #3498db; display:flex; justify-content:space-between;">
            <span id="chatting-with">Email</span>
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:20px;">&times;</button>
        </div>
        <div id="admin-chat-box" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
        <div style="padding:15px; display:flex; gap:10px; background:#0b0e11;">
            <input type="text" id="replyText" placeholder="Type reply...">
            <button class="btn" style="background:#2ecc71;" onclick="sendReply()">SEND</button>
        </div>
    </div>
</div>

<script>
    let currentChatEmail = "";

    function tab(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    auth.onAuthStateChanged(u => {
        if(u && u.email === "abdullahiisah09060@gmail.com") { document.body.style.display="block"; start(); }
        else { window.location.href="index.html"; }
    });

    function start() {
        // 1. Pending Requests
        db.collection('requests').where('status', '==', 'pending').onSnapshot(snap => {
            let html = '';
            snap.forEach(doc => {
                const r = doc.data();
                html += `<div class="card">
                    <b>${r.email}</b><br><small>${r.type}</small>
                    <h2 style="margin:5px 0; color:#2ecc71;">$${r.amount}</h2>
                    <button class="btn" style="background:#2ecc71; width:48%" onclick="handleReq('${doc.id}','${r.email}',${r.amount},'successful')">APPROVE</button>
                    <button class="btn" style="background:#e74c3c; width:48%" onclick="handleReq('${doc.id}','',0,'declined')">DECLINE</button>
                </div>`;
            });
            document.getElementById('list-req').innerHTML = html || "No pending requests.";
        });

        // 2. Transaction History
        db.collection('requests').where('status', 'in', ['successful', 'declined']).orderBy('timestamp', 'desc').onSnapshot(snap => {
            let html = '';
            snap.forEach(doc => {
                const r = doc.data();
                const color = r.status === 'successful' ? '#2ecc71' : '#e74c3c';
                html += `<div class="card" style="border-left: 4px solid ${color}">
                    <span class="status-badge" style="background:${color}">${r.status}</span>
                    <b>${r.email}</b><br><small>${r.type}</small><br>
                    <b>$${r.amount}</b>
                </div>`;
            });
            document.getElementById('list-history').innerHTML = html || "No transactions yet.";
        });

        // 3. User Management
        db.collection('users').onSnapshot(snap => {
            let html = '';
            snap.forEach(doc => {
                const u = doc.data();
                html += `<div class="card u-card">
                    <b>${u.fullName}</b><br><small>${u.email}</small><br>
                    <b style="color:#3498db">Balance: $${u.balance}</b>
                    <input type="number" id="amt-${doc.id}" placeholder="Amount">
                    <button class="btn" style="background:#3498db; width:48%" onclick="modBal('${doc.id}','add')">ADD</button>
                    <button class="btn" style="background:#555; width:48%" onclick="modBal('${doc.id}','sub')">SUB</button>
                    <button class="btn" style="background:#e74c3c; width:100%; margin-top:10px;" onclick="killUser('${doc.id}')">DELETE USER</button>
                </div>`;
            });
            document.getElementById('list-users').innerHTML = html;
        });

        // 4. Inbox Listener
        db.collection('chats').orderBy('timestamp', 'desc').onSnapshot(snap => {
            let uniqueEmails = [];
            snap.forEach(doc => {
                if(!uniqueEmails.includes(doc.data().userEmail)) uniqueEmails.push(doc.data().userEmail);
            });
            let html = '';
            uniqueEmails.forEach(email => {
                html += `<div class="card" onclick="openChat('${email}')" style="cursor:pointer;">
                    ${email} <span style="float:right; color:#3498db;">View Chat &rarr;</span>
                </div>`;
            });
            document.getElementById('list-chats').innerHTML = html || "No messages.";
        });
    }

    async function handleReq(id, email, amt, status) {
        if(status === 'successful') {
            const userQuery = await db.collection('users').where('email', '==', email).get();
            if(!userQuery.empty) {
                const userRef = userQuery.docs[0].ref;
                const oldBal = Number(userQuery.docs[0].data().balance || 0);
                await userRef.update({ balance: oldBal + Number(amt) });
            }
        }
        await db.collection('requests').doc(id).update({ status: status });
    }

    async function modBal(id, type) {
        const val = Number(document.getElementById('amt-'+id).value);
        if(!val) return;
        const ref = db.collection('users').doc(id);
        const doc = await ref.get();
        const current = Number(doc.data().balance || 0);
        await ref.update({ balance: type === 'add' ? current + val : current - val });
        document.getElementById('amt-'+id).value = '';
    }

    async function killUser(id) { if(confirm("Permanently delete this user?")) await db.collection('users').doc(id).delete(); }

    function openChat(email) {
        currentChatEmail = email;
        document.getElementById('chatting-with').innerText = email;
        document.getElementById('admin-chat-overlay').style.display = 'flex';
        
        db.collection('chats').where('userEmail', '==', email).orderBy('timestamp', 'asc').onSnapshot(snap => {
            let html = '';
            snap.forEach(doc => {
                const m = doc.data();
                const style = m.sender === 'admin' ? 'background:#3498db; align-self:flex-end;' : 'background:#2c2f36; align-self:flex-start; border:1px solid #444;';
                html += `<div style="padding:10px; border-radius:10px; max-width:80%; color:white; ${style}">${m.message}</div>`;
            });
            const box = document.getElementById('admin-chat-box');
            box.innerHTML = html;
            box.scrollTop = box.scrollHeight;
        });
    }

    function closeChat() { document.getElementById('admin-chat-overlay').style.display = 'none'; }

    async function sendReply() {
        const input = document.getElementById('replyText');
        if(!input.value.trim()) return;
        await db.collection('chats').add({
            userEmail: currentChatEmail,
            message: input.value,
            sender: 'admin',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = '';
    }

    function filter() {
        let q = document.getElementById('userSearch').value.toLowerCase();
        document.querySelectorAll('.u-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(q) ? '' : 'none');
    }
</script>
</body>
</html>
